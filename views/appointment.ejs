<!DOCTYPE html>
<html lang="en">
    <head>
        <!-- Popperjs -->
        <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js" crossorigin="anonymous"></script>
        <!-- Tempus Dominus JavaScript -->
        <script src="https://cdn.jsdelivr.net/npm/@eonasdan/tempus-dominus@6.7.19/dist/js/tempus-dominus.min.js" crossorigin="anonymous"></script>
        
        <!-- Tempus Dominus Styles -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@eonasdan/tempus-dominus@6.7.19/dist/css/tempus-dominus.min.css" crossorigin="anonymous">
    </head>
    <%- include('layouts/head')  %>

    <body>
        <!-- Responsive navbar-->
        <%- include('layouts/navbar')  %>

        <!-- Header-->
        <header class="bg-dark py-1">
            <div class="container px-5">
                <div class="row gx-5 justify-content-center">
                    <div class="col-lg-6">
                        <div class="text-center my-5">
                            <h1 class="display-5 fw-bolder text-white mb-2">Create Appointment Slots</h1>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Form section-->
        <section class="bg-light py-5">
            <div class="container px-1 my-1 px-1">
                <div class="row gx-1 justify-content-center">
                    <div class="col-lg-6">
                        <% if(errors != null && errors.length  > 0) { %>
                            <% for(var i=0; i < errors.length; i++) { %>
                                <div class="alert alert-danger">
                                    <%= errors[i] %>
                                </div>
                            <% } %>
                        <% } %>

                        <% if(messages != null && messages.length  > 0) { %>
                            <% for(var i=0; i < messages.length; i++) { %>
                                <div class="alert alert-success">
                                    <%= messages[i] %>
                                </div>
                            <% } %>
                        <% } %>
                        <form class="appointment-form" action="/admins/appointments#picker" method="POST">
                            <!-- DATE PICKER -->
                            <div class="calendar-container">
                                <div class="calendar-item">
                                    <div class="log-event" id="picker"></div>
                                </div>
                                <div class="list-appointment-slots-item">
                                    <div class="btn-group appointment-slot-list">
                                        <input type="radio"
                                        class="btn-check"
                                        name="appointmentTime"
                                        id="option1"
                                        autocomplete="off"
                                        value="09:00" />
                                        <label class="btn btn-outline-primary"
                                        for="option1">09:00</label>

                                        <input type="radio"
                                        class="btn-check"
                                        name="appointmentTime"
                                        id="option2"
                                        autocomplete="off"
                                        value="09:30" />
                                        <label class="btn btn-outline-primary"
                                        for="option2">09:30</label>

                                        <input type="radio"
                                        class="btn-check"
                                        name="appointmentTime"
                                        id="option3"
                                        autocomplete="off"
                                        value="10:00" />
                                        <label class="btn btn-outline-primary"
                                        for="option3">10:00</label>

                                        <input type="radio"
                                        class="btn-check"
                                        name="appointmentTime"
                                        id="option4"
                                        autocomplete="off"
                                        value="10:30" />
                                        <label class="btn btn-outline-primary"
                                        for="option4">10:30</label>

                                        <input type="radio"
                                        class="btn-check"
                                        name="appointmentTime"
                                        id="option5"
                                        autocomplete="off"
                                        value="11:00" />
                                        <label class="btn btn-outline-primary"
                                        for="option5">11:00</label>

                                        <input type="radio"
                                        class="btn-check"
                                        name="appointmentTime"
                                        id="option6"
                                        autocomplete="off"
                                        value="11:30" />
                                        <label class="btn btn-outline-primary"
                                        for="option6">11:30</label>

                                        <input type="radio"
                                        class="btn-check"
                                        name="appointmentTime"
                                        id="option7"
                                        autocomplete="off"
                                        value="12:00" />
                                        <label class="btn btn-outline-primary"
                                        for="option7">12:00</label>

                                        <input type="radio"
                                        class="btn-check"
                                        name="appointmentTime"
                                        id="option8"
                                        autocomplete="off"
                                        value="12:30" />
                                        <label class="btn btn-outline-primary"
                                        for="option8">12:30</label>

                                        <input type="radio"
                                        class="btn-check"
                                        name="appointmentTime"
                                        id="option9"
                                        autocomplete="off"
                                        value="13:00" />
                                        <label class="btn btn-outline-primary"
                                        for="option9">13:00</label>

                                        <input type="radio"
                                        class="btn-check"
                                        name="appointmentTime"
                                        id="option10"
                                        autocomplete="off"
                                        value="13:30" />
                                        <label class="btn btn-outline-primary"
                                        for="option10">13:30</label>
                                    </div>
                                </div>
                            </div>

                            <div class="btn-appointment-add-item">
                                <button type="submit"
                                    id="btn-add-appointment"
                                    class="btn btn-primary btn-lg"
                                    data-aos="flip-up">ADD APPOINTMENT</button>
                            </div>

                        </form>

                    </div>
                </div>
            </div>
            <div id="serverTime" style="display:none"><%= serverTime %></div>
        
        </section>

        <!-- Footer-->
        <%- include('layouts/footer')  %>
        <!-- Bootstrap core JS-->
        <%- include('layouts/scripts')  %>

        <script>
            // datepicker setup
            const minDateText = document.getElementById('serverTime').textContent
            const minDate = new Date(minDateText).setHours(0, 0, 0, 0)
            const picker = new tempusDominus.TempusDominus(document.getElementById('picker'), {
                display: {
                    inline: true,
                    components: {
                    decades: true,
                    year: true,
                    month: true,
                    date: true,
                    hours: false,
                    minutes: false,
                    seconds: false,
                    }
                },
                stepping: 30,
                restrictions: {
                    minDate: new Date(minDate),
                },
                promptTimeOnDateChange: true,
            } )

            //creating appointment slot
            const form = document.querySelector("form")
            form.addEventListener("submit", event => {
                event.preventDefault()
            
                const calDate = picker.viewDate
            
                let appDate = document.createElement("input")
                appDate.setAttribute("type", "text")
                appDate.setAttribute("name", "appointmentDate")
                appDate.setAttribute(
                    "value",
                    calDate.toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit'
                    })
                );
                appDate.style.display = "none"
                form.appendChild(appDate)
                form.submit()
                appDate.remove()
                })
            
            
                // appointment slot logic
                const appButtons = document.getElementsByName("appointmentTime")
            
                const handleResponseError = ( response ) => {
                if( !response.ok ) {
                    throw response.status + ": " + response.statusText
                }
                return response.json()
                }
            
                const fail = (error) => {
                    console.log(error)
                    alert("Unable to retrieve appointment slots")
                }
            
                const succeed = (data) => {
                    appButtons.forEach(rb => {
                        data.appointment.forEach(app => {
                        if(rb.value === app.appointmentTime )
                            rb.setAttribute('disabled', true)
                        })
                    })
                }
            
                // getting appointment times for selected date
                picker.subscribe(tempusDominus.Namespace.events.change, (e) => {
                    appButtons.forEach( rb => {
                        rb.removeAttribute('disabled')
                    })
                
                    const selectedDate = e.date.toLocaleDateString('en-US', {
                        month: '2-digit',
                        day: '2-digit',
                        year: 'numeric'
                    }).split(',')[0]
                
                    const url = window.location.origin + `/admins/appointments/${selectedDate}`
                    fetch(url)
                        .then((response) => handleResponseError(response))
                        .then((data) => succeed(data))
                        .catch((error) => fail(error))
                })
            
                // disabling radio buttons on page load depending on date in calendar
                const presentDate = new Date(picker.viewDate).toLocaleDateString('en-US', {
                    month: '2-digit',
                    day: '2-digit',
                    year: 'numeric'
                }).split(',')[0]
                const url = window.location.origin + `/admins/appointments/${presentDate}`
                fetch(url)
                    .then((response) => handleResponseError(response))
                    .then((data) => succeed(data))
                    .catch((error) => fail(error))
        </script>
    </body>
</html>

