<!DOCTYPE html>
<html lang="en">
    <%- include('layouts/head')  %>

    <body>
        <!-- Responsive navbar-->
        <%- include('layouts/navbar')  %>

        <!-- Header-->
        <header class="bg-dark py-1">
            <div class="container px-5">
                <div class="row gx-5 justify-content-center">
                    <div class="col-lg-6">
                        <div class="text-center my-5">
                            <h1 class="display-5 fw-bolder text-white mb-2">G2 Test</h1>
                            <p class="lead text-white-50 mb-4">G2 Test Booking Page</p>
                        </div>
                    </div>
                </div>
            </div>
        </header>
        <!-- Form section-->
        <section class="bg-light py-5">
            <div class="container px-5 my-5 px-5">
                <div class="row gx-5 justify-content-center">
                    <div class="col-lg-6">
                        
                        <% if(errors != null && errors.length  > 0) { %>
                            <% for(var i=0; i < errors.length; i++) { %>
                                <div class="alert alert-danger">
                                    <%= errors[i] %>
                                </div>
                            <% } %>
                        <% } %>

                        <% if (messages && messages.success && messages.success.length > 0) { %>
                            <% messages.success.forEach(message => { %>
                                <div class="alert alert-success">
                                    <%= message %>
                                </div>
                            <% }) %>
                        <% } %>

                        <% if (user.examinerComment != '' && user.testResult != null) { %>
                            <div class="col-12">
                                <p><%= `Test Type: ${user.testType}` %></p>
                                <p><%= 'Test Result: ' %><span class="<%= user.testResult ? 'text-success' : 'text-danger' %>"><%- user.testResult ? 'Pass' : 'Fail'%></span></p>
                                <p><%= `Examiner Comment: ${user.examinerComment}` %></p>    
                            </div>
                        <% } %>

                        <form class="registration-form" action="/update" method="post" enctype="multipart/form-data">
                            <fieldset >
                                <legend>Personal Information</legend>
                                <!-- First Name input-->
                                <div class="form-floating mb-3">
                                    <input 
                                        class="form-control" 
                                        id="first-name" 
                                        name="firstName" 
                                        type="text" 
                                        value="<%= user ? user.firstName : '' %>" 
                                        <% if (user.firstName != '') { %> readonly="readonly" <% } %> 
                                    />
                                    <label for="first-name">First Name</label>
                                </div>

                                <!-- Last Name input-->
                                <div class="form-floating mb-3">
                                    <input 
                                        class="form-control" 
                                        id="last-name" 
                                        name="lastName" 
                                        type="text" 
                                        value="<%= user ? user.lastName : '' %>" 
                                        <% if (user.lastName != '') { %> readonly="readonly" <% } %> 
                                    />
                                    <label for="last-name">Last Name</label>
                                </div>

                                <!-- Age input-->
                                <div class="form-floating mb-3">
                                    <input 
                                        class="form-control" 
                                        id="age" 
                                        name="age" 
                                        type="number" 
                                        value="<%= user ? user.age : null %>"
                                        <% if (user.age != null) { %> readonly="readonly" <% } %> 
                                    />
                                    <label for="age">Age</label>
                                </div>

                                <!-- License number input-->
                                <div class="form-floating mb-3">
                                    <input 
                                        class="form-control" 
                                        id="license-number" 
                                        name="licenseNo" 
                                        type= "text"
                                        value= "<%= user ? user.licenseNo : '' %>"
                                        <% if (user.licenseNo != '') { %> readonly="readonly" <% } %> 
                                    />
                                    <label for="license-number">License Number</label>
                                </div>
                            </fieldset>

                            <br>
                            
                            <fieldset>
                                <legend name="carDetails">Car Details</legend>
                                <!-- Car make input-->
                                <div class="form-floating mb-3">
                                    <input 
                                        class="form-control" 
                                        id="car-make" 
                                        name="make" 
                                        type="text" 
                                        value="<%= user ? user.carDetails.make : '' %>"
                                    />
                                    <label for="car-make">Make</label>
                                </div>
                                <!-- Car model input-->
                                <div class="form-floating mb-3">
                                    <input 
                                        class="form-control" 
                                        id="car-model" 
                                        name="model" 
                                        type="text" 
                                        value="<%= user ? user.carDetails.model : '' %>"
                                    />
                                    <label for="car-model">Model</label>
                                </div>
                                <!-- Year input-->
                                <div class="form-floating mb-3">
                                    <input
                                        class="form-control" 
                                        id="manufacture-year" 
                                        name="year" 
                                        type="number" 
                                        value="<%= user ? user.carDetails.year : null %>"
                                    />
                                    <label for="manufacture-year">Year</label>
                                </div>
                                <!-- Plate number input-->
                                <div class="form-floating mb-3">
                                    <input 
                                        class="form-control" 
                                        id="plate-number" 
                                        name="platNo" 
                                        type="text" 
                                        value="<%= user ? user.carDetails.platNo : '' %>"
                                    />
                                    <label for="plate-number">Plate Number</label>
                                </div>

                            </fieldset>
                
                            <div class="d-grid"><button class="btn btn-primary btn-lg" type="submit">Save</button></div>
                        </form>
                        <br>

                        <!-- Date picker form -->
                        
                            <!-- Display driver's saved data -->
                            <% if(user.firstName != "" && user.lastName != "") { %>
                        
                                <% if (appointment && !user.examinerComment) { %>
                                    <div class="alert alert-info">
                                        You have an existing appointment on <%= appointment.appointmentDate %> at <%= appointment.appointmentTime %>.
                                    </div>
                                <% } else if (!appointment && !user.examinerComment){ %>
                                <form class="date-picker-form" action="/g2test/submitDate" method="post" enctype="multipart/form-data">
                                    <div class="date-time">
                                        <div class="select-date">
                                            <label for="appointment-date">Select Appointment Date</label>
                                            <input class="form-control" id="appointment-date" name="appointmentDate" type="date" required onchange="fetchAvailableTimeSlots()"/>
                                            
                                        </div>
                            
                                        <!-- Display available time slots for the selected date -->
                                        <div id="available-slots">
                                            <label for="appointment-time">Select Appointment Time:</label>
                                            <select class="form-select" id="appointment-time" name="appointmentTime" required>
                                                <!-- Time slots will be dynamically populated using JavaScript -->
                                            </select>
                                        </div>
                                    </div>
                                    <div class="d-grid"><button  id="btn-save-appointment" class="btn btn-primary btn-lg" type="submit">Save Appointment</button></div>
                                </form>
                                <% } %>
                            <% } else { %>
                                <% if (messages && messages.warning && messages.warning.length > 0) { %>
                                    <% messages.warning.forEach(message => { %>
                                        <div class="alert alert-warning">
                                            <%= message %>
                                        </div>
                                    <% }) %>
                                <% } %>
                            <% } %>
                        
                    </div>
                </div>
            </div>
        </section>
        <!-- Footer-->
        <%- include('layouts/footer')  %>
        <!-- Bootstrap core JS-->
        <%- include('layouts/scripts')  %>

        <script>
            async function fetchAvailableTimeSlots() {
                try {
                    // Get the selected date from the date picker
                    const rawSelectedDate = document.getElementById('appointment-date').value;
                    const selectedDateObject = new Date(rawSelectedDate);
                    
                    // Set the time part to 12:00 PM (noon) in UTC
                    selectedDateObject.setUTCHours(12, 0, 0, 0);
        
                    // Format the selected date as MM/DD/YYYY
                    const selectedDate = selectedDateObject.toLocaleDateString('en-US', {
                        month: '2-digit',
                        day: '2-digit',
                        year: 'numeric'
                    });
        
                    // Make a request to the server to get available time slots
                    const response = await fetch(`/g2test/availableTimeSlots?date=${selectedDate}`);
                    const data = await response.json();
        
                    // Update the UI with the fetched time slots
                    const timeSlotSelect = document.getElementById('appointment-time');
                    timeSlotSelect.innerHTML = ''; // Clear existing options
        
                    data.availableSlots.forEach(slot => {
                        const option = document.createElement('option');
                        option.value = slot;
                        option.text = slot;
                        timeSlotSelect.add(option);
                    });
                } catch (error) {
                    console.error('Error fetching available time slots:', error);
                }
            }
        </script>
        
    </body>
</html>

